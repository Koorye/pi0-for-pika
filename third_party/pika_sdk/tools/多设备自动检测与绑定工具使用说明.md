# 多设备自动检测与绑定工具使用说明

## 功能介绍

这是一个专为Pika设备设计的多设备自动检测与绑定工具，可以根据用户输入的设备数量，依次引导用户插入设备并自动检测绑定。主要功能包括：

1. 支持任意数量的Pika设备配置
2. 自动检测每个设备的RealSense相机序列号
3. 自动检测每个设备的ttyUSB端口
4. 交互式检测每个设备的鱼眼相机
5. 自动生成udev规则，实现设备与固定端口的绑定

## 使用方法

### 前置条件

为获得最佳效果，请确保系统已安装以下软件包：

```bash
# 1、安装v4l-utils（用于视频设备检测）
sudo apt install v4l-utils

# 2、安装RealSense sdk 工具（用于RealSense相机检测）

# 3、安装 OpenCV（用于相机图像获取）
pip install opencv-python
```

### 运行脚本

1. 确保所有Pika设备已断开连接
2. 运行脚本：

```bash
cd  pika_sdk
python3 tools/multi_device_detector.py
```

3. 按照脚本提示操作：
   - 输入需要配置的设备数量
   - 依次插入每个设备，按回车继续
   - 当显示相机画面时，按`s`键选择鱼眼相机，按`q`键跳过
   - 完成所有设备检测后，选择是否立即应用规则

### 操作流程

1. 脚本启动后，会首先检查必要的工具是否安装
2. 输入需要配置的设备数量（例如：3）
3. 插入第1个设备，按回车继续
4. 脚本自动检测第1个设备的RealSense序列号和ttyUSB端口
5. 脚本显示可用的相机画面，在看到鱼眼相机时按`s`键选择，非鱼眼相机按`q`键跳过
6. 拔出第1个设备，插入第2个设备，按回车继续
7. 重复步骤4-5，直到完成所有设备的检测
8. 脚本生成配置文件，询问是否立即应用规则
9. 如选择应用规则，脚本会自动执行udev规则设置

## 优化更新说明

根据您的要求，脚本已进行以下优化：

1. **相机检测交互优化**：
   - 画面会停留在当前video，直到用户按下q或s键才会切换
   - 按q键跳过当前相机，按s键选择当前相机作为鱼眼相机

2. **设备编号调整**：
   - 所有设备编号从80开始
   - 第1个设备：ttyUSB81, video81
   - 第2个设备：ttyUSB82, video82
   - 以此类推...

3. **视频设备匹配范围扩展**：
   - 视频设备匹配范围已扩展到video0-video60
   - 支持更多的视频设备类型

4. **简化输出文件**：
   - 移除了示例代码生成，只保留必要的配置文件
   - 生成的文件更加精简和实用

## 生成的文件

脚本运行后会生成以下文件：

1. **setup.bash**：设备绑定规则脚本，用于设置udev规则
2. **devices_info.conf**：设备信息配置文件，包含所有设备的详细信息

## 设备绑定规则

脚本会为每个设备分配固定的设备路径：

- 第1个设备：ttyUSB81, video81
- 第2个设备：ttyUSB82, video82
- 第3个设备：ttyUSB83, video83
- 以此类推...

## 在Pika SDK中使用绑定后的设备

```python
from pika import sense

# 使用第1个设备
device1 = sense('/dev/ttyUSB81')
device1.connect()
device1.set_fisheye_camera_index(81)  # 使用第1个设备的鱼眼相机

# 使用第2个设备
device2 = sense('/dev/ttyUSB82')
device2.connect()
device2.set_fisheye_camera_index(82)  # 使用第2个设备的鱼眼相机

# 使用完毕后断开连接
device1.disconnect()
device2.disconnect()
```

## 注意事项

1. 设备检测过程中，请确保每次只插入一个设备
2. 设备绑定后，必须插入原来检测时使用的同一个USB口
3. 如果设备插入不同的USB口，绑定规则可能无法正确应用
4. 如需重新配置，只需再次运行脚本即可
5. 如果检测过程中出现问题，可以按Ctrl+C中断脚本，然后重新运行
